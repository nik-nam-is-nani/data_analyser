<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weekly Data Analyzer</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Dark mode */
    body.dark-mode {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #ecf0f1;
    }
    body.dark-mode .navbar {
      background: #1e272e;
      color: white;
    }
    body.dark-mode .navbar a { color: #ecf0f1; }
    body.dark-mode .navbar a:hover { color: #3498db; }
    body.dark-mode .expenses { background: #2f3640; color: #f5f6fa; }
    body.dark-mode .stats-card { background: #353b48; color: #dcdde1; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh; display: flex; flex-direction: column;
    }
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      background: white; padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .navbar-left a, .navbar-right a {
      margin: 0 15px; text-decoration: none; color: #34495e;
      font-weight: 700; transition: color 0.3s;
    }
    .navbar a:hover { color: #3498db; }
    .profile-icon {
      position: relative; cursor: pointer; font-size: 22px;
    }
    .profile-dropdown {
      display: none; position: absolute; right: 0; background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px; margin-top: 10px; z-index: 1000; min-width: 120px;
    }
    .profile-dropdown a {
      display: block; padding: 10px 15px; text-decoration: none; color: #34495e;
    }
    .profile-dropdown a:hover { background: #f0f0f0; }
    .main-container {
      display: flex; justify-content: space-between; padding: 20px; flex: 1;
    }
    .expenses {
      flex: 1; background: white; border-radius: 20px; padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .welcome-message { margin-bottom: 20px; font-size: 1.5em; color: #2c3e50; }
    .stats-card {
      background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;
    }
    .stats-card h3 { margin-bottom: 15px; color: #34495e; text-align: center; }
    .chart-container { width: 100%; max-width: 600px; margin: 20px auto; }
    canvas { width: 100% !important; height: 350px !important; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 10px; text-align: center;
    }
    th { background: #3498db; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-left">
      <a href="mainpage.html">Dashboard</a>
      <a href="week_db.html">Weekly Data Analyzer</a>
      <a href="expensive_manager.html">Expense Manager</a>
    </div>
    <div class="navbar-right">
      <a href="login.html" id="loginLink">Login</a>
      <a href="signup.html" id="signupLink">Signup</a>
      <div class="profile-icon" id="profileIcon" style="display: none;" onclick="toggleDropdown()">
        ðŸ‘¤
        <div class="profile-dropdown" id="profileDropdown">
          <a href="#" onclick="toggleDarkMode()">ðŸŒ— Toggle Dark Mode</a>
          <a href="#">Settings</a>
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="expenses">
      <div class="welcome-message" id="welcomeMsg">Welcome, Guest ðŸ‘‹</div>
      <div class="stats-card">
        <h3>Last Week's Expense Summary</h3>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
        <table>
          <thead>
            <tr><th>Week</th><th>Amount ($)</th></tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let barChart, pieChart;
    let userFromDB = JSON.parse(localStorage.getItem("user")) || { loggedIn: false };

    window.onload = function() {
      if (userFromDB.loggedIn) {
        document.getElementById("profileIcon").style.display = "block";
        document.getElementById("loginLink").style.display = "none";
        document.getElementById("signupLink").style.display = "none";
        document.getElementById("welcomeMsg").innerText = "Welcome, " + userFromDB.username + " ðŸ‘‹";
      }
      fetchExpenseData();
    };

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }

    function toggleDropdown() {
      const dropdown = document.getElementById("profileDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    function logout() {
      alert("Logged out!");
      localStorage.removeItem("user");
      location.reload();
    }

    async function fetchExpenseData() {
      try {
        // Replace with real API: http://127.0.0.1:5000/api/weekly_expenses/{id}
        const data = {
          weeks: [
            {week: "Week 1", amount: 120},
            {week: "Week 2", amount: 200},
            {week: "Week 3", amount: 150}
          ],
          categories: [
            {category: "Food", amount: 100},
            {category: "Travel", amount: 80},
            {category: "Shopping", amount: 120}
          ]
        };

        const weeklyData = data.weeks;
        const categoryData = data.categories;

        // Fill Table
        const dataBody = document.getElementById("dataBody");
        dataBody.innerHTML = "";
        weeklyData.forEach(d => {
          dataBody.innerHTML += `<tr><td>${d.week}</td><td>$${d.amount}</td></tr>`;
        });

        // Destroy old charts
        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        // Pie Chart
        pieChart = new Chart(document.getElementById("pieChart"), {
          type: 'pie',
          data: {
            labels: categoryData.map(c => c.category),
            datasets: [{
              data: categoryData.map(c => c.amount),
              backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4CAF50", "#9966FF"]
            }]
          },
          options: {
            plugins: { legend: { position: 'bottom' } }
          }
        });

        // Bar Chart
        barChart = new Chart(document.getElementById("barChart"), {
          type: 'bar',
          data: {
            labels: weeklyData.map(d => d.week),
            datasets: [{
              label: 'Amount Spent ($)',
              data: weeklyData.map(d => d.amount),
              backgroundColor: "#36A2EB"
            }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      } catch (err) {
        console.error("Error loading data", err);
      }
    }
  </script>
</body>
</html>
